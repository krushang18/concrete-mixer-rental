name: Deploy Concrete Mixer Rental

on:
  push:
    branches: [main]

env:
  NODE_VERSION: "20"
  DEPLOY_PATH: "/var/www/fioriforrent.com"
  PM2_APP_NAME: "concrete-mixer-api"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: krushang
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 300s
          command_timeout: 900s

          script: |
            set -e

            echo "ðŸš€ Deployment started at $(date)"

            cd /var/www/fioriforrent.com

            echo "ðŸ“¦ Pulling latest code"
            git fetch origin
            git reset --hard origin/main

            COMMIT=$(git rev-parse --short HEAD)
            echo "âœ… Commit: $COMMIT"

            # ================= BACKEND =================
            echo "ðŸ”§ Backend setup"
            cd backend
            npm ci --omit=dev
            mkdir -p uploads/{company,quotations,signatures,temp}
            chmod -R 755 uploads
            pm2 restart ecosystem.config.js --env production || pm2 start ecosystem.config.js --env production
            cd ..

            # ================= ADMIN FRONTEND =================
            echo "ðŸ§± Building admin frontend"
            cd admin-frontend
            npm ci --omit=dev

            cat > .env.production <<'EOF'
            REACT_APP_API_BASE_URL=https://fioriforrent.com/api
            REACT_APP_ENV=production
            REACT_APP_APP_NAME=Concrete Mixer Rental Admin
            REACT_APP_VERSION=2.0.0
            EOF

            CI=false npm run build

            sudo mkdir -p /var/www/fioriforrent.com/admin
            sudo rsync -a --delete build/ /var/www/fioriforrent.com/admin/
            cd ..

            # ================= CUSTOMER SITE =================
            echo "ðŸŒ Deploying customer site"
            sudo rsync -a --delete customer-site/ /var/www/fioriforrent.com/customer-site/

            # ================= PM2 =================
            echo "â™» Saving PM2 state"
            pm2 save

            # ================= HEALTH CHECK =================
            sleep 5
            curl -f http://127.0.0.1:3000/health

            echo "ðŸŽ‰ Deployment successful"
            echo "Commit: $COMMIT"
